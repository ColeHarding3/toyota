--[[
    TOYOTA - Tracked Operations Yielding Optimized Turtle Automation - 2025 Cole

    This program is licensed under the MIT license.
    http://opensource.org/licenses/mit-license.php

    I will attempt to create an API that tracks turtle movements even when the
    turtle is moving while the game shuts down or whatever. I will use fuel
    for directional moving, and some kind of backtracking for rotation.

    The API is relatively basic, in that it is purely focused on movement. It's
    essentially a rich drop-in replacement for the the original navigational
    functions in the turtle API:
        turtle.forward   -> toyota.forward
        turtle.back      -> toyota.back
        turtle.up        -> toyota.up
        turtle.down      -> toyota.down
        turtle.turnRight -> toyota.turnRight
        turtle.turnLeft  -> toyota.turnLeft

    When using this API, you must not use any other functions that alter
    the turtle's position or facing. In particular:

        DO NOT USE turtle.forward, turtle.back, turtle.up, turtle.down,
        turtle.turnRight or turtle.turnLeft NOR THEIR NATIVE EQUIVALENTS.

    Any other external force changing the turtle's position will also
    invalidate the coordinates, of course (such as the player pickaxing the
    turtle and placing it somewhere else or RP2 frames).

    This was inspired by LAMA - Location Aware Movement API - 2013 Sangar
]]


-------------------------------------------------------------------------------
-- Config                                                                    --
-------------------------------------------------------------------------------

-- The absolute path to this file. This is used for generating startup logic
-- which initializes the API by loading it into the OS.
local apiPath = "apis/lama"

-- This is the name of the file in which we store our state, i.e. the position
-- and facing of the turtle, as well as whether it is currently moving or not.
-- We split this up into several files to keep file i/o while moving minimal.
-- You may want to change this if it collides with another program or API.
local stateFile = {
    position  = "/.lama-state",
    waypoints = "/.lama-waypoints",
    fuel      = "/.lama-fuel",
    move      = "/.lama-move-state",
    path      = "/.lama-path-state",
    wrap      = "/.lama-wrap-state"
}


function supertest()
    print("super test worked from TOYOTA")
end

function readFuelState()
    if not fs.exists(stateFile.fuel) then
        return nil
    end

    local file = fs.open(stateFile.fuel, "r")
    if file then
        local fuel = tonumber(file.readLine())
        file.close()
        return fuel
    end
    return nil
end

function writeFuelState(fuel)
    local file = fs.open(stateFile.fuel, "w")
    if file then
        file.writeLine(tostring(fuel))
        file.close()
    end
end

function toyotaforward()
    print("toyota forward start")

    -- Get initial fuel level from the state file
    local initialFuel = readFuelState() or 0

    -- Open a file for logging
    local logFile = fs.open("fuel_log.txt", "a")
    if logFile then
        logFile.writeLine("Initial Fuel: " .. tostring(initialFuel))
    end

    -- Attempt to move forward
    local success = turtle.forward()

    -- Get the new fuel level from turtle API and update state file
    local finalFuel = turtle.getFuelLevel()
    writeFuelState(finalFuel)

    -- Log the result
    if logFile then
        logFile.writeLine("Final Fuel: " .. tostring(finalFuel))
        logFile.writeLine("Fuel Used: " .. tostring(initialFuel - finalFuel))
        logFile.writeLine("Move Success: " .. tostring(success))
        logFile.writeLine("------------------------")
        logFile.close()
    end

    print("toyota forward end")
end


